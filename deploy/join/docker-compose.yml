services:
  tmkms:
    image: ghcr.io/product-science/tmkms-softsign-with-keygen:0.1.23
    container_name: tmkms
    restart: unless-stopped
    environment:
      - VALIDATOR_LISTEN_ADDRESS=tcp://node:${TMKMS_PORT:-26658}
    volumes:
      - .tmkms:/root/.tmkms

  node:
    container_name: node
    image: ghcr.io/product-science/inferenced:0.1.23
    command: ["sh", "./init-docker.sh"]
    volumes:
      - .inference:/root/.inference
      - ../../genesis/genesis.json:/root/genesis.json
    environment:
      - SEED_NODE_RPC_URL=${SEED_NODE_RPC_URL}
      - SEED_NODE_P2P_URL=${SEED_NODE_P2P_URL}
      - SNAPSHOT_INTERVAL=1000
      - SNAPSHOT_KEEP_RECENT=5
      - TRUSTED_BLOCK_PERIOD=${TRUSTED_BLOCK_PERIOD:-2000}
      - KEY_NAME=${KEY_NAME}
      - P2P_EXTERNAL_ADDRESS=${P2P_EXTERNAL_ADDRESS}
      - CONFIG_p2p__allow_duplicate_ip=true
      - CONFIG_p2p__handshake_timeout=30s
      - CONFIG_p2p__dial_timeout=30s
      - TMKMS_PORT=${TMKMS_PORT:-26658}
      - SYNC_WITH_SNAPSHOTS=true
      - RPC_SERVER_URL_1=${RPC_SERVER_URL_1}
      - RPC_SERVER_URL_2=${RPC_SERVER_URL_2}
      - REST_API_ACTIVE=true
      - INIT_ONLY=false
      - IS_GENESIS=true
      - GENESIS_SEEDS=c637495acea140a2f76e52b20f7e80e5cb6784ef@gonka.spv.re:5000,c2556c33c3c30f04f31817815eab844104fea034@47.236.26.199:5000,dbca3846804a0495850048e35898b97c60fb89ab@195.242.13.239:5000,9712d51caa666c15c0ae37067d61e312209aa51d@36.189.234.197:18027,f99c57f258ef042d02bce33482135fb5cfb69bdb@185.216.21.98:5000,5511e206df2d7e582bd329ff2bfcdc2c79a3445e@47.236.19.22:15000,94c113ce4e2f7f6ffcacae238a924342a7a8b0df@36.189.234.237:17240,44f7c802202a7aed0c6a7facff7bf009268c28eb@89.169.103.180:5000,345cb118044901a7df585a6925b84193ac281c71@69.19.136.233:5000
    ports:
      - "5000:26656" #p2p
      - "26657:26657" #rpc
    expose:
      - "${TMKMS_PORT:-26658}"
    depends_on:
      - tmkms
    restart: always

  api:
    container_name: api
    image: ghcr.io/product-science/api:0.1.23
    volumes:
      - .inference:/root/.inference
      - .dapi:/root/.dapi
      - ${NODE_CONFIG:-./node-config.json}:/root/node_config.json
    depends_on:
      - node
    environment:
      - KEY_NAME=${KEY_NAME}
      - ACCOUNT_PUBKEY=${ACCOUNT_PUBKEY}
      - KEYRING_BACKEND=file
      - KEYRING_PASSWORD=${KEYRING_PASSWORD}
      - DAPI_API__POC_CALLBACK_URL=${DAPI_API__POC_CALLBACK_URL}
      - DAPI_API__PUBLIC_URL=${PUBLIC_URL}
      - DAPI_CHAIN_NODE__SEED_API_URL=${SEED_API_URL}
      - DAPI_CHAIN_NODE__URL=${DAPI_CHAIN_NODE__URL}
      - DAPI_CHAIN_NODE__P2P_URL=${DAPI_CHAIN_NODE__P2P_URL}
      - NODE_CONFIG_PATH=/root/node_config.json
      - DAPI_API__PUBLIC_SERVER_PORT=9000
      - DAPI_API__ML_SERVER_PORT=9100
      - DAPI_API__ADMIN_SERVER_PORT=9200
    ports:
      - "9100:9100"
      - "9200:9200"
    restart: always
  
  proxy:
    container_name: proxy
    image: ghcr.io/product-science/proxy:0.1.23
    ports:
      - "${API_PORT:-8000}:80"
    environment:
      - API_PORT=9000
      - CHAIN_RPC_PORT=26657
      - CHAIN_API_PORT=1317
      - CHAIN_GRPC_PORT=9090
      - DASHBOARD_PORT=5173
    depends_on:
      - node
      - api
      - explorer
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  explorer:
    container_name: explorer
    image: ghcr.io/product-science/explorer:latest
    expose:
      - "5173"
    restart: unless-stopped

